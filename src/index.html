<html>
<header>
  <title>Welcome to Casa Domus</title>
</header>

<body>
  <h2>Welcome to Casa Domus</h2>

  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
  <script src="http://127.0.0.1/~MarbleCake/papaparse.js" type="text/javascript"></script>
  <script src="http://127.0.0.1/~MarbleCake/searchCounty.js" type="text/javascript"></script>
  <script src="http://127.0.0.1/~MarbleCake/resources/data.js" type="text/javascript"></script>

  <!- Angularjs View ->
  <div ng-app="mainApp" ng-controller="surveyController">

    <!- Input ->
    <table border="0">
      <tr>
        <td>Lets ask some questions first.</td>
      </tr>

      <tr></tr>

      <tr>
        <td>What is your current median household income?</td>
        <td>
          <input type="range" min="20000" max="200000" value="110000" class="slider" ng-model="userIncome">{{userIncome | currency}}
        </td>
      </tr>

      <tr>
        <td>How much property value can you afford?</td>
        <td>
          <input type="range" min="19800" max="1000000" value="509900" class="slider" ng-model="userProperty">{{userProperty | currency}}
        </td>
      </tr>

      <tr>
        <td>How far do you want you dollar to go? (Cost of living index)</td>
        <td>
          <input type="range" min="88" max="188" value="136.5" class="slider" ng-model="userLiving">{{userLiving}}
        </td>
      </tr>

      <tr>
        <td>How much can you afford to spend on rent a month?</td>
        <td>
          <input type="range" min="400" max="3000" value="1700" class="slider" ng-model="userRent">{{userRent | currency}}
        </td>
      </tr>

      <tr>
        <td>
          <button ng-click="calculateDistance()">Submit</button>
        </td>
      </tr>
    </table>

    <!- Crudely print the top 10 closest counties ->
    {{resultString}}
  </div>

  <script>
    // Makes all json county data available
    parseCountyData();

    // Angularjs Controller
    var mainApp = angular.module("mainApp", []);

    mainApp.controller('surveyController', function ($scope) {
      // Distances of counties to user's preferences
      $scope.userDist = [];
      // String with Output
      $scope.resultString = "";

      // User values (default values)
      $scope.userIncome = 110000;
      $scope.userProperty = 509900;
      $scope.userLiving = 136.5;
      $scope.userRent = 1700;

      $scope.calculateDistance = function () {
        // contains candidate county to compare against
        $scope.county = null;
        $scope.userDist = [];

        // Loop through all counties and calculate distances
        for (var key = 0; key < countyList.length; key++) {
          countyToSearch = countyList[key].countyName;
          stateToSearch = countyList[key].state;

          $scope.county = searchCounty(countyToSearch, stateToSearch);

          $scope.dist = 0;

          // Only calculate the distance of those counties that have these values
          if (($scope.county.medianProperty) &&
          ($scope.county.costOfLiving) &&
          ($scope.county.medianHHIncome) &&
          ($scope.county.rent1bed)) {

            $scope.dist = Math.hypot(($scope.county.medianProperty - $scope.userProperty),
              ($scope.county.costOfLiving - $scope.userLiving),
              ($scope.county.medianHHIncome - $scope.userIncome),
              ($scope.county.rent1bed - $scope.userRent)
            );
          }

          // only insert if the distance exists
          if (!Number.isNaN($scope.dist) && $scope.dist != 0) {
            $scope.userDist.push({
              state: rentJSON[key].state_alpha,
              areaName: rentJSON[key].cntyname + ", " + rentJSON[key].state_alpha,
              countyName: rentJSON[key].cntyname,
              distance: $scope.dist
            });
          }
        }

        $scope.userDist.sort(sortByProperty('distance'));

        console.log($scope.userDist);

        this.printResults();
      }

      // the most barbaric way to print the results
      $scope.printResults = function () {
        $scope.resultString = "";
        $scope.resultString += "Here are some Suggestions: ";
        $scope.resultString += $scope.userDist[0].areaName + " ";
        $scope.resultString += $scope.userDist[1].areaName + " ";
        $scope.resultString += $scope.userDist[2].areaName + " ";
        $scope.resultString += $scope.userDist[3].areaName + " ";
        $scope.resultString += $scope.userDist[4].areaName + " ";
        $scope.resultString += $scope.userDist[5].areaName + " ";
        $scope.resultString += $scope.userDist[6].areaName + " ";
        $scope.resultString += $scope.userDist[7].areaName + " ";
        $scope.resultString += $scope.userDist[8].areaName + " ";
        $scope.resultString += $scope.userDist[9].areaName + " ";
      }
    });
  </script>

</body>

</html>